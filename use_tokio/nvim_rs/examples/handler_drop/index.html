<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="`handler_drop`"><meta name="keywords" content="rust, rustlang, rust-lang, handler_drop"><title>nvim_rs::examples::handler_drop - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script src="../../../crates.js"></script><script defer src="../../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../nvim_rs/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../../nvim_rs/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Module handler_drop</a></h2><div class="sidebar-elems"><div id="sidebar-vars" data-name="handler_drop" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../nvim_rs/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Module <a href="../../index.html">nvim_rs</a>::<wbr><a href="../index.html">examples</a>::<wbr><a class="mod" href="#">handler_drop</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/nvim_rs/examples/handler_drop.rs.html#1-56">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="handler_drop"><a href="#handler_drop"><code>handler_drop</code></a></h2>
<p>An example of handling cleanup logic by implementing
<a href="https://doc.rust-lang.org/nightly/core/ops/drop/trait.Drop.html"><code>Drop</code></a> for the handler. The plugin attaches to the current
buffer, then sets the first 2 lines, which get sent back to us with a
<code>nvim_buf_lines_event</code> notification. We handle this notification by saving
the lines in the handler. We then let nvim close the channel, and wait for
the IO loop to finish. The handler gets dropped, and so our cleanup logic is
executed.</p>
<h3 id="usage"><a href="#usage">Usage</a></h3>
<p>First, build the neovim included as a submodule:</p>
<div class="example-wrap"><pre class="language-sh"><code>cd neovim
make</code></pre></div>
<p>See <a href="https://github.com/neovim/neovim/wiki/Building-Neovim">https://github.com/neovim/neovim/wiki/Building-Neovim</a> for build options.
Nothing is really needed to run the example.</p>
<p>After that, run the example via</p>
<div class="example-wrap"><pre class="language-sh"><code>cargo run --example handler_drop</code></pre></div>
<p>You can verify it worked by looking at the file <code>handler_drop.txt</code> in the
project directory which should contain 2 lines (“xyz” and “abc”).</p>
<h3 id="description"><a href="#description">Description</a></h3>
<ul>
<li>
<p>The associated type for our <a href="../../rpc/handler/trait.Handler.html"><code>Handler</code></a> is
the stdin of our child. But tokio’s
<a href="tokio::process::ChildStdin"><code>ChildStdin</code></a> does not implement
<a href="futures::io::AsyncWrite"><code>futures::io::AsyncWrite</code></a>, so it needs to be
wrapped in the provided <a href="../../compat/tokio/struct.Compat.html"><code>Compat</code></a> type.</p>
</li>
<li>
<p>Implementing <a href="https://doc.rust-lang.org/nightly/core/ops/drop/trait.Drop.html"><code>Drop</code></a> is straightforward, except that we
cannot do so asynchronously. Since dropping the handler is one of the last
things our plugin does, it’s not problem to run even larger code bodies
synchronously here.</p>
</li>
<li>
<p>The event handling code is not efficient, because we just read the
arguments by reference and clone them. It’s easy to take ownership directly
by matching on the enum <a href="../../enum.Value.html"><code>Value</code></a> directly, though.</p>
</li>
<li>
<p>There’s basically no error handling, other than <code>unwrap</code>ing all the
<code>Result</code>s.</p>
</li>
<li>
<p><code>await</code>ing the io future handle is probably not necessary, but feels like
a nice thing to do.</p>
</li>
<li>
<p>As with the other examples, we implement <a href="futures::task::Spawn"><code>Spawn</code></a>
for our <code>NeovimHandler</code> most trivially.</p>
</li>
</ul>
</div></details></section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="nvim_rs" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.61.0-nightly (0677edc86 2022-03-31)" ></div>
</body></html>